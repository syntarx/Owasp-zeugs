package org.example;

import org.owasp.dependencycheck.Engine;
import org.owasp.dependencycheck.dependency.Dependency;
import org.owasp.dependencycheck.dependency.Vulnerability;
import org.owasp.dependencycheck.reporting.ReportGenerator;
import org.owasp.dependencycheck.reporting.ReportGenerator.Format;
import org.owasp.dependencycheck.reporting.ReportGenerator.ReportType;
import org.owasp.dependencycheck.utils.Settings;

import java.io.File;
import java.util.List;

public class VulnerabilityScanner {
    public static void main(String[] args) {
        Settings settings = new Settings();
        try (Engine engine = new Engine(settings)) {
            // Set the path to the Maven POM file
            String pathToPom = "pom.xml";

            // Scan the POM file
            engine.scan(new File(pathToPom));

            // Analyze dependencies
            engine.analyzeDependencies();

            // Get the list of dependencies
            List<Dependency> dependencies = List.of(engine.getDependencies());

            // Print vulnerabilities
            for (Dependency dependency : dependencies) {
                for (Vulnerability vulnerability : dependency.getVulnerabilities()) {
                    System.out.println("Dependency: " + dependency.getFileName());
                    System.out.println("Vulnerability: " + vulnerability.getName());
                    System.out.println("Description: " + vulnerability.getDescription());
                    System.out.println("Severity: " + (vulnerability.getCvssV2() != null
                            ? vulnerability.getCvssV2().getScore()
                            : "N/A"));
                    System.out.println("------------------------------------------------------------");
                }
            }

            // Generate a report
            ReportGenerator reportGenerator = new ReportGenerator(
                    "Vulnerability Report",
                    settings,
                    null,
                    null,
                    engine.getDependencies(),
                    engine.getAnalyzers(),
                    ReportType.ALL
            );
            reportGenerator.generateReports("target", Format.ALL);
            System.out.println("Report generated: target/dependency-check-report.html");

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            settings.cleanup();
        }
    }
}
